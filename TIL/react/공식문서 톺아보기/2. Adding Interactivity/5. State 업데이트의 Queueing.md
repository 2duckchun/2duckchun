# State 업데이트의 Queueing (대기열)
- 컴포넌트의 state가 변경되면 렌더링 대기열에 추가된다.
- 그러나 떄로는 렌더링이 이뤄지기 전에 state를 이용한 여러 작업을 해야할 수도 있다.
- 이를 위해서 리액트 state 업데이트의 배치(batches) 시스템을 이해해야 한다.

## 리액트 state 업데이트 배치 시스템
- setState가 여러개 있다고 해서 setState를 만날때마다 렌더링 되는게 아니다.
```js
import React, { useState } from 'react';

export function App(props) {
  const [number, setNumber] = useState(0);
    const handleClick = () => {
    console.log('Before', number);
    setNumber(number + 1);
    setNumber(number + 1);
    setNumber(number + 1);
    setNumber(number + 1);
    console.log('After', number);
  };

  return (
    <div>
      <p>Number: {number}</p>
      <button onClick={handleClick}>Increment</button>
    </div>
  );
}

/** 처음 버튼 클릭시 콘솔로그
 *  Before 0
 *  After 0
 */
/** 두번째 버튼 클릭시 콘솔로그
 *  Before 1
 *  After 1
 */

```
- 위의 코드에서 버튼을 클릭하게 되면 `setNumber`(state 변경)이 각 `console.log`의 중간에 있음에도 불구하고, `console.log`가 모두 출력된다.
- 즉, 하나의 이벤트 핸들러가 모두 끝날때까지 렌더링 과정은 잠시 멈추게 되며,
- 이벤트 핸들러가 종료되면 state 변경에 따른 렌더링 과정이 진행된다.
- 즉, 한번에 처리함(batche)으로써 쓸데없는 렌더링 소요를 줄일 수 있게 된다.

## 리렌더링 전에 업데이트된 state 사용하는 방법
### updater function
```js
import { useState } from 'react';

export default function Counter() {
  const [number, setNumber] = useState(0);

  return (
    <>
      <h1>{number}</h1>
      <button onClick={() => {
        setNumber(n => n + 1);
        setNumber(n => n + 1);
        setNumber(n => n + 1);
      }}>+3</button>
    </>
  )
}
```
- 위 코드를 통해 생성된 버튼을 클릭하게 되면 +3씩 제대로 증가하게 된다.
- setState 내부에 콜백함수로 `updater function`을 호출하고 있기 때문이다.
- 리액트는 이벤트 핸들러가 끝나고 이 함수들이 실행될 수 있도록, setState 내부 코드들을 대기열(queue)에 저장한다.
- 이벤트 핸들러가 종료된 후 리렌더링이 될 때, **큐에 먼저 들어간 `setState`의 `updater function`들이 미리 실행된 후**, 리렌더링이 시작된다.

|대기 업데이트|n|리턴값|
|------|---|---|
|n => n + 1|0|0 + 1 = 1|
|n => n + 1|1|1 + 1 = 2|
|n => n + 1|2|2 + 1 = 3|

- `setNumber(n + 1)` 과 같이 고정된 스냅샷의 state로 값을 산출하는게 아니라
- 이전 값(prevState)을 불러와 콜백함수로 큐에 넣고 차례차례 호출하는 것이므로
- 의도한대로 값이 출력된다.
---

```js
// ...
  const [number, setNumber] = useState(0);
  const handleClick = () => {
    setNumber(number + 5);
    setNumber(n => n + 1);
    setNumber(42);
  };
//...
```
스냅샷 : 0 (고정)
|대기 업데이트|n|리턴값|
|------|---|---|
|스냅샷 + 5|0|5|
|n => n + 1|5|5 + 1 = 6|
|42|6|42|
- 위와 같은 경우에는 큐가 위 테이블처럼 구성되어 있을 것이라고 유추할 수 있다.
---

## Recap
- [ ] 상태를 변경하면 변경된 상태를 기반으로 새롭게 렌더링을 요청한다.
- [ ] 리액트는 쓸데없는 리렌더링을 막기 위해 이벤트 핸들러가 완료된 후 일괄적으로 상태 업데이트를 처리한 후 리렌더링을 시작한다. 이를 `batching`이라고 한다.
- [ ] 하나의 이벤트에서 일부 state를 여러번 업데이트하려면 업데이트 함수를 이용해야 한다. 
(콜백 함수이므로 먼저 Queue에 의해 실행되어 변경된 state를 사용할 수 있게 된다.)